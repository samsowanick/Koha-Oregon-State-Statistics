<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" href="https://link-to-your-favorite.favicon/favicon2.png" type="image/x-icon">
    <title>Koha State Reporting</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .report-preview-container {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            min-height: 600px;
            padding: 40px;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        /* Styles for the generated HTML report */
        .pretty-report {
            background: white;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            color: #1a202c;
            line-height: 1.6;
            border: 1px solid #eee;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .report-header {
            text-align: center;
            border-bottom: 3px solid #2d3748;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .report-section {
            margin-bottom: 30px;
        }

        .section-title {
            background: #f7fafc;
            padding: 8px 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-left: 4px solid #3182ce;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #2d3748;
        }

        .data-grid {
            width: 100%;
            border-collapse: collapse;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #edf2f7;
        }

        .data-label {
            color: #4a5568;
            font-size: 0.95rem;
        }

        .data-value {
            font-weight: 600;
            color: #2d3748;
        }

        .report-footer {
            margin-top: 50px;
            font-size: 0.8rem;
            color: #a0aec0;
            text-align: center;
            border-top: 1px solid #edf2f7;
            padding-top: 20px;
        }

        @media print {
            body * { visibility: hidden; }
            .pretty-report, .pretty-report * { visibility: visible; }
            .pretty-report { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; }
        }

        input:focus {
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #bfdbfe;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800">Koha State Reporting</h1>
            <p class="text-slate-500">Input manual fields and automatically pull statstics from Koha.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 mb-8">
            <div class="flex items-center gap-2 mb-6 pb-2 border-b border-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <h2 class="font-bold text-slate-800">Report Configuration</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">General</h3>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Fiscal Year</label>
                        <input type="text" id="val-year" placeholder="YYYY" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50">
						<ln>Enter the last of the fiscal year. 2025 = FY 24/25.</ln>
					</div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Usage (Part 8)</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-[11px] font-medium text-slate-600 mb-1">Internet Users</label>
                            <input type="text" id="val-internet-users" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50">
                        </div>
                        <div>
                            <label class="block text-[11px] font-medium text-slate-600 mb-1">Number of Computers</label>
                            <input type="text" id="val-internet-computers" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50">
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Connectivity (Part 8)</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-[11px] font-medium text-slate-600 mb-1">Upload Speed</label>
                            <input type="text" id="val-speed-up" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50">
                        </div>
                        <div>
                            <label class="block text-[11px] font-medium text-slate-600 mb-1">Download Speed</label>
                            <input type="text" id="val-speed-down" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50">
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Systems (Part 8)</h3>
                    <div>
                        <label class="block text-[11px] font-medium text-slate-600 mb-1">ILS Vendor</label>
                        <input type="text" id="val-ils" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50">
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-100 flex justify-center">
                <button id="generate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-12 rounded-xl transition-all flex items-center gap-3 shadow-lg hover:shadow-blue-200 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    <span>Run Report</span>
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-slate-700">Report Preview</h2>
            <div class="flex gap-2">
                <button id="copy-btn" class="text-slate-600 bg-white border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 transition flex items-center gap-2 text-sm font-medium shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Copy Text
                </button>
                <button onclick="window.print()" class="text-slate-600 bg-white border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 transition flex items-center gap-2 text-sm font-medium shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Print
                </button>
            </div>
        </div>

        <div class="report-preview-container" id="report-container">
            <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-4" id="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="text-lg font-medium">Ready to generate report</p>
            </div>
        </div>
    </div>

    <script>
		//Create associated reports in Koha. Make them public. Update the below list with the report ids.
        const fieldConfig = [
            { id: 'patroncount', reportId: '111' },
            { id: 'newpatroncount', reportId: '222' },
            { id: 'bookstotal', reportId: '333' },
            { id: 'bookstotaladded', reportId: '444' },
            { id: 'audiototal', reportId: '555' },
            { id: 'audiototaladded', reportId: '666' },
            { id: 'videototal', reportId: '777' },
            { id: 'videototaladded', reportId: '888' },
            { id: 'othertotal', reportId: '999' },
            { id: 'othertotaladded', reportId: '000' },
            { id: 'espanoltotal', reportId: '001' },
            { type: 'combined', circId: 'adultcircs', renewId: 'adultrenewals', reportId: '400' },
            { type: 'combined', circId: 'yacircs', renewId: 'yarenewals', reportId: '300' },
            { type: 'combined', circId: 'childcircs', renewId: 'childrenewals', reportId: '200' },
            { id: 'nonrescircs', reportId: '100' }
        ];

        const BASE_URL = "https://your.public.koha-url/cgi-bin/koha/svc/report?id=";

        $(document).ready(function() {
            // Setup defaults
            const currentYear = new Date().getFullYear();
            $('#val-year').val(`${currentYear}`); //<-- sets the default in the browser to the current year.
            $('#val-speed-up').val('10 Mbps');
            $('#val-speed-down').val('10 Mbps');
            $('#val-ils').val('ByWater Solutions');
            
            // New Defaults per request
            $('#val-internet-users').val('n/a');
            $('#val-internet-computers').val('49');
            
            $('#generate-btn').on('click', async function() {
                const btn = $(this);
                const yearVal = $('#val-year').val().trim();
                
                if (!yearVal) {
                    alert('Please enter a Fiscal Year');
                    return;
                }

                const yearParam = yearVal.split('/')[0].trim();

                btn.prop('disabled', true).addClass('opacity-50').find('span').text('Running...');
                $('#empty-state').hide();
                $('#report-container').html('<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>');
                
                const data = { 
                    year: yearVal,
                    internet_speed_up: $('#val-speed-up').val(),
                    internet_speed_down: $('#val-speed-down').val(),
                    ils: $('#val-ils').val(),
                    internet_users: $('#val-internet-users').val(),
                    internet_computers: $('#val-internet-computers').val()
                };
                
                for (const field of fieldConfig) {
                    try {
                        const url = `${BASE_URL}${field.reportId}&sql_params=${encodeURIComponent(yearParam)}`;
                        const response = await fetch(url);
                        const json = await response.json();
                        
                        if (json?.[0]?.[0]) {
                            let val = String(json[0][0]);
                            
                            if (field.type === 'combined') {
                                const parts = val.split(',');
                                data[field.circId] = parts[0] || "0";
                                data[field.renewId] = parts[1] || "0";
                            } else {
                                data[field.id] = val.includes(',') ? val.split(',')[0] : val;
                            }
                        } else {
                            if (field.type === 'combined') {
                                data[field.circId] = "0";
                                data[field.renewId] = "0";
                            } else {
                                data[field.id] = "0";
                            }
                        }
                    } catch (e) {
                        if (field.type === 'combined') {
                            data[field.circId] = "—";
                            data[field.renewId] = "—";
                        } else {
                            data[field.id] = "—";
                        }
                    }
                }

                const reportHTML = buildPrettyTemplate(data);
                $('#report-container').html(reportHTML);
                
                btn.prop('disabled', false).removeClass('opacity-50').find('span').text('Run Report & Fetch Data');
            });

            $('#copy-btn').on('click', function() {
                const reportElement = document.querySelector('.pretty-report');
                if (!reportElement) return;

                let plainText = "";
                const sections = reportElement.querySelectorAll('.report-section');
                
                plainText += reportElement.querySelector('.report-header h1').innerText + "\n";
                plainText += reportElement.querySelector('.report-header p').innerText + "\n\n";

                sections.forEach(section => {
                    const title = section.querySelector('.section-title').innerText;
                    plainText += `--- ${title} ---\n`;
                    
                    const rows = section.querySelectorAll('.data-row');
                    rows.forEach(row => {
                        const label = row.querySelector('.data-label').innerText;
                        const value = row.querySelector('.data-value').innerText;
                        plainText += `${label}: ${value}\n`;
                    });
                    plainText += "\n";
                });

                plainText += reportElement.querySelector('.report-footer').innerText;

                const dummy = document.createElement("textarea");
                document.body.appendChild(dummy);
                dummy.value = plainText;
                dummy.select();
                document.execCommand("copy");
                document.body.removeChild(dummy);
                
                const btn = $(this);
                const original = btn.html();
                btn.html('✓ Copied Text');
                setTimeout(() => btn.html(original), 2000);
            });
        });

        function buildPrettyTemplate(v) {
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            return `
            <div class="pretty-report">
                <div class="report-header">
                    <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0;">State Library Statistics Report</h1>
                    <p style="color: #718096; font-size: 0.9rem; margin: 5px 0 0 0;">Fiscal Year ${v.year}</p>
                </div>

                <div class="report-section">
                    <div class="section-title">Part 1 - General Information</div>
                    <div class="data-grid">
                        <div class="data-row">
                            <span class="data-label">(118) Number of registered users</span>
                            <span class="data-value">${v.patroncount}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">(119) Number of new registered users</span>
                            <span class="data-value">${v.newpatroncount}</span>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="section-title">Part 5 Section A - Physical Collection</div>
                    <div class="data-grid">
                        <div class="data-row"><span class="data-label">(501) Print items</span><span class="data-value">${v.bookstotal}</span></div>
                        <div class="data-row"><span class="data-label">(502) Print items added</span><span class="data-value">${v.bookstotaladded}</span></div>
                        <div class="data-row"><span class="data-label">(503) Physical audio items</span><span class="data-value">${v.audiototal}</span></div>
                        <div class="data-row"><span class="data-label">(504) Physical audio items added</span><span class="data-value">${v.audiototaladded}</span></div>
                        <div class="data-row"><span class="data-label">(505) Physical video items</span><span class="data-value">${v.videototal}</span></div>
                        <div class="data-row"><span class="data-label">(506) Physical video items added</span><span class="data-value">${v.videototaladded}</span></div>
                        <div class="data-row"><span class="data-label">(507) Other Physical materials</span><span class="data-value">${v.othertotal}</span></div>
                        <div class="data-row"><span class="data-label">(508) Other Physical materials added</span><span class="data-value">${v.othertotaladded}</span></div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="section-title">Part 6 - Library Services</div>
                    <div class="data-grid">
                        <div class="data-row"><span class="data-label">(610) Circulation of adult materials</span><span class="data-value">${v.adultcircs}</span></div>
                        <div class="data-row"><span class="data-label">(611) Renewals of adult materials</span><span class="data-value">${v.adultrenewals}</span></div>
                        <div class="data-row"><span class="data-label">(612) Circulation of young adult materials</span><span class="data-value">${v.yacircs}</span></div>
                        <div class="data-row"><span class="data-label">(613) Renewals of young adult materials</span><span class="data-value">${v.yarenewals}</span></div>
                        <div class="data-row"><span class="data-label">(614) Circulation of children's materials</span><span class="data-value">${v.childcircs}</span></div>
                        <div class="data-row"><span class="data-label">(615) Renewals of children's materials</span><span class="data-value">${v.childrenewals}</span></div>
                        <div class="data-row"><span class="data-label">(660) Circulation to non-residents</span><span class="data-value"> ${v.nonrescircs}</span>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="section-title">Part 8 - Library Technology</div>
                    <div class="data-grid">
                        <div class="data-row"><span class="data-label">(801) Annual use of public internet computers</span><span class="data-value">${v.internet_users}</span></div>
                        <div class="data-row"><span class="data-label">(802) Public internet computers available</span><span class="data-value">${v.internet_computers}</span></div>
                        <div class="data-row"><span class="data-label">(805) Internet upload speed</span><span class="data-value">${v.internet_speed_up}</span></div>
                        <div class="data-row"><span class="data-label">(806) Internet download speed</span><span class="data-value">${v.internet_speed_down}</span></div>
                        <div class="data-row"><span class="data-label">(808) Vendor of automated system</span><span class="data-value">${v.ils}</span></div>
                    </div>
                </div>

                <div class="report-footer">
                    Report compiled on ${date}. This data is sourced from Koha via live API reporting.
                </div>
            </div>`;
        }
    </script>
</body>
</html>